version: '3.7'

services:
  esp:
    image: "gcr.io/endpoints-release/endpoints-runtime:2.29.1"
    depends_on:
      - hello-api
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/etc/nginx/creds/credentials.json
    command:
        - "--listener_port=9000"
        - "--backend=hello:8080"
        - "--service=hello-api.endpoints.samyn-project4.cloud.goog"
        - "--rollout_strategy=managed"
        - "--service_account_key=/etc/nginx/creds/credentials.json"
        - "--cors_preset=basic"
        - "--cors_allow_origin=http://localhost:8080"
        - "--non_gcp"
        - "--enable_debug"
        - "--ssl_server_cert_path=/etc/esp/ssl"
    ports:
      - 9000:9000
    volumes:
      - ./local/files/sa-hello-api-credentials.json:/etc/nginx/creds/credentials.json
      - ./local/files/cert/dev/certificate.crt:/etc/esp/ssl/server.crt
      - ./local/files/cert/dev/private.key:/etc/esp/ssl/server.key

  hello-api:
    build:
      context: .
      dockerfile: ./docker/dev/Dockerfile
      target: stage_dev
    command: bash -c "
      cd cmd/apps/hello-api
      && go run main.go"
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: '/volumes/secrets/sa/credentials.json'
      SVC1_BASE_URL: 'http://svc1:8081'
      SVC2_BASE_URL: 'http://svc2:8082'
    ports:
      - '8080:8080'
    volumes:
      - .:/app
      - ./local/files/sa-hello-api-credentials.json:/volumes/secrets/sa/credentials.json
      - ./volumes/hello-api/go:/go

  svc1:
    build:
      context: .
      dockerfile: ./docker/dev/Dockerfile
      target: stage_dev
    command: bash -c "
      cd cmd/apps/hello-svc1
      && go run main.go"
    ports:
      - '8081:8081'
    volumes:
      - .:/app
      - ./volumes/hello-svc1/go:/go

  svc2:
    build:
      context: .
      dockerfile: ./docker/dev/Dockerfile
      target: stage_dev
    command: bash -c "
      cd cmd/apps/svc2
      && go run main.go"
    ports:
      - '8082:8082'
    volumes:
      - .:/app
      - ./volumes/hello-svc2/go:/go
